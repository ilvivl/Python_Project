
CREATE OR REPLACE FUNCTION num_for_one_frame() RETURNS int LANGUAGE plpgsql AS $$ -- создание переменной
DECLARE
  num_for_one_frame int;
BEGIN
  num_for_one_frame := 5;
  RETURN num_for_one_frame;
END
$$;

CREATE LANGUAGE plpythonu; -- create language if does not exist, ВЫДАЁТ ОШИБКУ!!!

CREATE OR REPLACE FUNCTION model_change(webpage_id INTEGER) -- short variant
DECLARE
  k int;
BEGIN
  k := num_for_one_frame();
  RETURNS void AS
  $BODY$
  import subprocess
  subprocess.call(['/Users/MaximZubkov/Desktop/Programming/Python/Python_Project/analysis.py, str(webpage_id), str(k)'])

  $BODY$
LANGUAGE plpythonu;



-- DROP TRIGGER IF EXISTS insert_lim ON data

CREATE OR REPLACE FUNCTION trigg_befor_ins() RETURNS trigger AS ' -- для триггера
BEGIN 
if(select count(*) FROM data WHERE webpage_id = NEW.webpage_id) >= (select num_for_one_frame())
	then select model_change(NEW.webpage_id); -- вызываем analysis.py
end if;
return NEW; -- делаем insert
END; 
' LANGUAGE  plpgsql;

CREATE TRIGGER insert_lim
BEFORE INSERT ON data
FOR EACH ROW 
EXECUTE PROCEDURE trigg_befor_ins()
